FROM node:20-alpine

# Build shared
WORKDIR /shared
COPY shared/package*.json ./
RUN npm install
COPY shared/tsconfig.json ./
COPY shared/src ./src
RUN npm run build

# Setup CLIENT
WORKDIR /app

# Copier shared compilé
RUN mkdir -p public/dist/shared
RUN cp -r /shared/dist/* public/dist/shared/

# Installer dépendances CLIENT
COPY client/package*.json ./
RUN npm install

# Copier le code CLIENT
COPY client/tsconfig.json ./
COPY client/src ./src
COPY client/public ./public

# Compiler une première fois
RUN npm run build

# Copier vers le volume pour nginx
RUN mkdir -p /output && cp -r /app/public/* /output/

EXPOSE 8080

# Lancer TypeScript en mode watch (recompile automatiquement)
# + Copier les fichiers vers /output à chaque changement
CMD ["sh", "-c", "while true; do npm run build -- --watch & sleep 5; cp -r /app/public/* /output/; sleep 10; done"]